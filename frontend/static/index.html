<!DOCTYPE html>
<html>
<head>
  <title>Color Tracking App</title>

  <style type="text/css">
    /* Split the screen in half */
    .split {
      height: 100%;
      width: 50%;
      position: fixed;
      z-index: 1;
      top: 0;
      overflow-x: hidden;
      padding-top: 20px;
    }

    /* Control the left side */
    .left {
      left: 0;
      background-color: white;
    }

    /* Control the right side */
    .right {
      right: 0;
      background-color: gray;
    }

    /* If you want the content centered horizontally and vertically */
    .centered {
      position: absolute;
      top: 20%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .centered.title {
      top: 5%;
      font-size: 1.5em;
    }

    .centered.content {
      top: 50%;
    }

    /* Table */
    table {
      width: 500px;
      height: 600px;
    }

    /* Colors */
    .red {
      background-color: red;
    }

    .blue {
      background-color: blue;
    }

    .yellow {
      background-color: yellow;
    }

    .green {
      background-color: green;
    }
  </style>

  <!-- Load jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <!-- Load d3.js -->
  <script src="https://d3js.org/d3.v4.js"></script>

  <!-- SocketIO -->
  <!-- <script src="https://cdn.socket.io/socket.io-3.0.0.js"></script> -->

  <!-- Action Cable -->
  <script src="action_cable.js"></script>
</head>
<body>
  <div class="split left">
    <div class="centered title">
      <h2>Hover/Click on Colors</h2>
    </div>
    <div id="table_colors" class="centered content"></div>
  </div>

  <div class="split right">
    <div class="centered title">
      <h2>Live Results</h2>
    </div>

    <div class="centered content">
      <div id="live_dashboards"><ul></ul></div>
      <div id="hovers_dashboard"></div>
      <div id="clicks_dashboard"></div>
    </div>
  </div>

  <footer>
    <a href="https://juanroldan.com.ar">juanroldan.com.ar</a>
  </footer>

  <!-- Colors Table Generation -->
  <script type="text/javascript">
    var rows = 10;
    var columns = 10;
    var table = $("<table>");

    for (var i = 0; i < columns; i++) {
      table.append("<tr>");

      for (var j = 0; j < rows; j++) {
        var colors = ["blue", "green", "red", "yellow"];
        var random = Math.floor(Math.random() * colors.length);
        table.append("<td class='" + colors[random] + "'></td>");
      };

      table.append("</tr>");
    };

    table.append("</table>");

    $("#table_colors").append(table);
  </script>
  <!-- Colors Table Generation -->

  <!-- Events Generation -->
  <script type="text/javascript">
    $(document).ready(function() {

      // Display "hover" effect on table cell colors
      $("td")
        .mouseenter(function() {
          var color = $(this).attr("class");
          var hoverColor = "dark" + color;
          $(this).css("background-color", hoverColor);
        })
        .mouseleave(function() {
          var color = $(this).attr("class");
          $(this).css("background-color", color);
        });

      // Trigger "hover" event
      $("td").mouseenter(function(){
        var color = this.className;
        console.log("Hovered on color: ", color);

        $.ajax({
          type: "POST",
          url: "http://localhost:3000/v1/action_colors",
          data: { action_color: { action_name: "hover", color_name: color } },
          beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization", "Token token=testing");
          }
        });
      });

      // Trigger "click" event
      $("td").click(function(){
        var color = this.className;
        console.log("Clicked on color: ", color);

        $.ajax({
          type: "POST",
          url: "http://localhost:3000/v1/action_colors",
          data: { action_color: { action_name: "click", color_name: color } },
          beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization", "Token token=testing");
          }
        });
      });
    });
  </script>
  <!-- Events Generation -->

  <!-- WebSockets with ActionCable -->
  <script type="text/javascript">
    var cable = ActionCable.createConsumer('ws://localhost:3000/cable')

    cable.subscriptions.create('ActionColorChannel', {
      connected: function() {
        console.log("You've subscribed to the ActionColor Channel");
      },
      disconnected: function() {
        console.log("You've disconnected from the ActionColor Channel");
      },
      received: function (data) {
        console.log("Received data: ", data);

        var results = data.operations.consoleLog[0].message.results;
        console.log("Received results: ", results);

        var colors = [];
        var colorsAndAmounts = {};

        $.each(results, function( key, val ) {
          colors.push(val.color);
          colorsAndAmounts[val.color] = parseInt(val.amount);
        });

        console.log(colors);
        console.log(colorsAndAmounts);

        // set the dimensions and margins of the graph
        var width = 350
            height = 350
            margin = 40

        // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
        var radius = Math.min(width, height) / 2 - margin

        // remove old graph to allow new graph to be rendered
        $("#hovers_dashboard").html("");

        // append the svg object to the div called 'hovers_dashboard'
        var svg = d3.select("#hovers_dashboard")
          .append("svg")
            .attr("width", width)
            .attr("height", height)
          .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        var data = {
          a: colorsAndAmounts["blue"],
          b: colorsAndAmounts["green"],
          c: colorsAndAmounts["red"],
          d: colorsAndAmounts["yellow"]
        }

        console.log(data);

        // set the color scale
        var color = d3.scaleOrdinal()
          .domain(data)
          .range(colors)

        // Compute the position of each group on the pie:
        var pie = d3.pie()
          .value(function(d) {return d.value; })
        var data_ready = pie(d3.entries(data))

        // shape helper to build arcs:
        var arcGenerator = d3.arc()
          .innerRadius(50)
          .outerRadius(radius)

        // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
        svg
          .selectAll("whatever")
          .data(data_ready)
          .enter()
          .append("path")
          .attr("d", d3.arc()
            .innerRadius(50)         // This is the size of the donut hole
            .outerRadius(radius)
          )
          .attr("fill", function(d){ return(color(d.data.key)) })
          .attr("stroke", "grey")
          .style("stroke-width", "5px")
          .style("opacity", 0.7)

        // Adding numbers inside each piece of the pie chart
        svg
          .selectAll("whatever")
          .data(data_ready)
          .enter()
          .append("text")
          .text(function(d){ return d.data.value })
          .attr("transform", function(d) { return "translate(" + arcGenerator.centroid(d) + ")";  })
          .style("text-anchor", "middle")
          .style("font-size", 30)

        // Adding "Hovers" title inside pie chart
        svg.append("text")
           .attr("text-anchor", "middle")
           .style("font-size", 25)
           .text("Hovers");
      }
    });
  </script>
  <!-- WebSockets with ActionCable -->

  <!-- Graphs Generation (Client Polling every 1 second) -->
  <!-- <script type="text/javascript">

    // Hovers Dashboard
    setInterval(function() {
      var colors = [];
      var colorsAndAmounts = {};

      $.ajax({
        type: "GET",
        dataType: "json",
        url: "http://localhost:3000/v1/action_colors",
        data: { action_name: "hover" },
        beforeSend: function (xhr) {
          xhr.setRequestHeader("Authorization", "Token token=testing");
        },
        success: function(data){

          $.each( data.results, function( key, val ) {
            colors.push(val.color);
            colorsAndAmounts[val.color] = parseInt(val.amount);
          });

          console.log(colors);
          console.log(colorsAndAmounts);

          // set the dimensions and margins of the graph
          var width = 350
              height = 350
              margin = 40

          // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
          var radius = Math.min(width, height) / 2 - margin

          // remove old graph to allow new graph to be rendered
          $("#hovers_dashboard").html("");

          // append the svg object to the div called 'hovers_dashboard'
          var svg = d3.select("#hovers_dashboard")
            .append("svg")
              .attr("width", width)
              .attr("height", height)
            .append("g")
              .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

          var data = {
            a: colorsAndAmounts["blue"],
            b: colorsAndAmounts["green"],
            c: colorsAndAmounts["red"],
            d: colorsAndAmounts["yellow"]
          }

          console.log(data);

          // set the color scale
          var color = d3.scaleOrdinal()
            .domain(data)
            .range(colors)

          // Compute the position of each group on the pie:
          var pie = d3.pie()
            .value(function(d) {return d.value; })
          var data_ready = pie(d3.entries(data))

          // shape helper to build arcs:
          var arcGenerator = d3.arc()
            .innerRadius(50)
            .outerRadius(radius)

          // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
          svg
            .selectAll("whatever")
            .data(data_ready)
            .enter()
            .append("path")
            .attr("d", d3.arc()
              .innerRadius(50)         // This is the size of the donut hole
              .outerRadius(radius)
            )
            .attr("fill", function(d){ return(color(d.data.key)) })
            .attr("stroke", "grey")
            .style("stroke-width", "5px")
            .style("opacity", 0.7)

          // Adding numbers inside each piece of the pie chart
          svg
            .selectAll("whatever")
            .data(data_ready)
            .enter()
            .append("text")
            .text(function(d){ return d.data.value })
            .attr("transform", function(d) { return "translate(" + arcGenerator.centroid(d) + ")";  })
            .style("text-anchor", "middle")
            .style("font-size", 30)

          // Adding "Hovers" title inside pie chart
          svg.append("text")
             .attr("text-anchor", "middle")
             .style("font-size", 25)
             .text("Hovers");
        }
      });

    }, 1000);

    // Clicks Dashboard
    setInterval(function() {
      var colors = [];
      var colorsAndAmounts = {};

      $.ajax({
        type: "GET",
        dataType: "json",
        url: "http://localhost:3000/v1/action_colors",
        data: { action_name: "click" },
        beforeSend: function (xhr) {
          xhr.setRequestHeader("Authorization", "Token token=testing");
        },
        success: function(data){

          $.each( data.results, function( key, val ) {
            colors.push(val.color);
            colorsAndAmounts[val.color] = parseInt(val.amount);
          });

          console.log(colors);
          console.log(colorsAndAmounts);

          // set the dimensions and margins of the graph
          var width = 350
              height = 350
              margin = 40

          // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
          var radius = Math.min(width, height) / 2 - margin

          // remove old graph to allow new graph to be rendered
          $("#clicks_dashboard").html("");

          // append the svg object to the div called 'clicks_dashboard'
          var svg = d3.select("#clicks_dashboard")
            .append("svg")
              .attr("width", width)
              .attr("height", height)
            .append("g")
              .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

          var data = {
            a: colorsAndAmounts["blue"],
            b: colorsAndAmounts["green"],
            c: colorsAndAmounts["red"],
            d: colorsAndAmounts["yellow"]
          }

          console.log(data);

          // set the color scale
          var color = d3.scaleOrdinal()
            .domain(data)
            .range(colors)

          // Compute the position of each group on the pie:
          var pie = d3.pie()
            .value(function(d) {return d.value; })
          var data_ready = pie(d3.entries(data))

          // shape helper to build arcs:
          var arcGenerator = d3.arc()
            .innerRadius(50)
            .outerRadius(radius)

          // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
          svg
            .selectAll("whatever")
            .data(data_ready)
            .enter()
            .append("path")
            .attr("d", d3.arc()
              .innerRadius(50)         // This is the size of the donut hole
              .outerRadius(radius)
            )
            .attr("fill", function(d){ return(color(d.data.key)) })
            .attr("stroke", "grey")
            .style("stroke-width", "5px")
            .style("opacity", 0.7)

          // Adding numbers inside each piece of the pie chart
          svg
            .selectAll("whatever")
            .data(data_ready)
            .enter()
            .append("text")
            .text(function(d){ return d.data.value })
            .attr("transform", function(d) { return "translate(" + arcGenerator.centroid(d) + ")";  })
            .style("text-anchor", "middle")
            .style("font-size", 30)

          // Adding "Hovers" title inside pie chart
          svg.append("text")
             .attr("text-anchor", "middle")
             .style("font-size", 25)
             .text("Clicks");
        }
      });

    }, 1000);
  </script> -->
  <!-- Graphs Generation (Client Polling every 1 second) -->

  <!-- WebSockets with SocketIO -->
<!--   <script type="text/javascript">
    const socket = io("ws://localhost:3000/cable", {
      reconnectionDelayMax: 10000,
      auth: {
        token: "testing",
        Access-Control-Allow-Origin: "yes"
      },
      query: {
        "my-key": "my-value"
      }
    });

    // listening for the `message` event from the server
    socket.on("message", text => {
      const el = document.createElement("li");
      el.innerHTML = text;
      document.querySelector("ul").appendChild(el);
    })
  </script> -->
  <!-- WebSockets with SocketIO -->
</body>
</html>
