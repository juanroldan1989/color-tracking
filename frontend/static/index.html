<!DOCTYPE html>
<html>
<head>
  <title>Color Tracking App</title>

  <style type="text/css">
    /* Split the screen in half */
    .split {
      height: 100%;
      width: 50%;
      position: fixed;
      z-index: 1;
      top: 0;
      overflow-x: hidden;
      padding-top: 20px;
    }

    /* Control the left side */
    .left {
      left: 0;
      background-color: white;
    }

    /* Control the right side */
    .right {
      right: 0;
      background-color: red;
    }

    /* If you want the content centered horizontally and vertically */
    .centered {
      position: absolute;
      top: 20%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .centered.title {
      top: 20%;
    }

    .centered.content {
      top: 50%;
    }

    /* Style the image inside the centered container, if needed */
    .centered img {
      width: 150px;
      border-radius: 50%;
    }

    /* Table */
    table {
      width: 300px;
      height: 300px;
    }

    /* Colors */
    .red {
      background-color: red;
    }

    .blue {
      background-color: blue;
    }

    .yellow {
      background-color: yellow;
    }

    .green {
      background-color: green;
    }
  </style>

  <!-- Load jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <!-- Load d3.js -->
  <script src="https://d3js.org/d3.v4.js"></script>
</head>
<body>
  <div class="split left">
    <div class="centered title">
      <!-- <img src="img_avatar2.png" alt="Avatar woman"> -->
      <h2>Hover & Click on Colors</h2>
      <!-- <p>Some text.</p> -->
    </div>

    <div class="centered content">
      <table>
        <tr>
          <td class="green"></td>
          <td class="green"></td>
          <td class="red"></td>
          <td class="blue"></td>
        </tr>
        <tr>
          <td class="green"></td>
          <td class="red"></td>
          <td class="green"></td>
          <td class="red"></td>
        </tr>
        <tr>
          <td class="green"></td>
          <td class="green"></td>
          <td class="red"></td>
          <td class="green"></td>
        </tr>
        <tr>
          <td class="blue"></td>
          <td class="red"></td>
          <td class="green"></td>
          <td class="yellow"></td>
        </tr>
        <tr>
          <td class="green"></td>
          <td class="green"></td>
          <td class="blue"></td>
          <td class="red"></td>
        </tr>
        <tr>
          <td class="green"></td>
          <td class="yellow"></td>
          <td class="green"></td>
          <td class="blue"></td>
        </tr>
        <tr>
          <td class="red"></td>
          <td class="blue"></td>
          <td class="yellow"></td>
          <td class="green"></td>
        </tr>
      </table>
    </div>
  </div>

  <div class="split right">
    <div class="centered title">
      <h2>Live Results</h2>
      <!-- <p>Some text.</p> -->
    </div>

    <div class="centered content">
      <div id="my_dataviz" class="img"></div>

      <!-- Colors Hovered On -->

      <!-- Colors Clicked On and How Many Times -->
    </div>
  </div>

  <footer>
    <a href="https://juanroldan.com.ar">juanroldan.com.ar</a>
  </footer>

  <!-- Events Generation -->
  <script type="text/javascript">
    $(document).ready(function() {
      $("td").hover(function(){
        var color = this.className;
        console.log("Hovered on color: ", color);

        $.post("http://localhost:3000/v1/action_colors", { action_color: { user_id: "1", action_name: "hover", color_name: color} });
      });

      $("td").click(function(){
        var color = this.className;
        console.log("Clicked on color: ", color);

        $.post("http://localhost:3000/v1/action_colors", { action_color: { user_id: "1", action_name: "click", color_name: color} });
      });
    });
  </script>
  <!-- Events Generation -->

  <!-- Graphs Generation -->
  <script type="text/javascript">

    // refresh graph from API response every 1 second
    setInterval(function(){ 
      // $.get("http://localhost:3000/v1/action_colors?action_name=hover", function(data, status){
      //     console.log("Data: " + data[0] + "\nStatus: " + status);
      // });

      var colors = [];
      var colorsAndAmounts = {};

      $.ajax({
        type    : "GET",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        url      : "http://localhost:3000/v1/action_colors?action_name=hover",
        success  : function(data){

          $.each( data.results, function( key, val ) {
            colors.push(val.color);
            colorsAndAmounts[val.color] = parseInt(val.amount);
          });

          console.log(colors);
          console.log(colorsAndAmounts);

          // set the dimensions and margins of the graph
          var width = 450
              height = 450
              margin = 40

          // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
          var radius = Math.min(width, height) / 2 - margin

          // remove old graph to allow new graph to be rendered
          $("#my_dataviz").html("");

          // append the svg object to the div called 'my_dataviz'
          var svg = d3.select("#my_dataviz")
            .append("svg")
              .attr("width", width)
              .attr("height", height)
            .append("g")
              .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

          var data = {a: colorsAndAmounts["red"], b: colorsAndAmounts["blue"], c:colorsAndAmounts["yellow"], d: colorsAndAmounts["green"]}

          console.log(data);

          // set the color scale
          var color = d3.scaleOrdinal()
            .domain(data)
            .range(colors)

          // Compute the position of each group on the pie:
          var pie = d3.pie()
            .value(function(d) {return d.value; })
          var data_ready = pie(d3.entries(data))

          // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
          svg
            .selectAll('whatever')
            .data(data_ready)
            .enter()
            .append('path')
            .attr('d', d3.arc()
              .innerRadius(100)         // This is the size of the donut hole
              .outerRadius(radius)
            )
            .attr('fill', function(d){ return(color(d.data.key)) })
            .attr("stroke", "black")
            .style("stroke-width", "2px")
            .style("opacity", 0.7)
        }
      });

    }, 1000);

  </script>
  <!-- Graphs Generation -->
</body>
</html>
